#!/bin/bash

set -e

. ~/.bashrc

# log levels: debug info warning error none
: ${RABBITMQ_LOG_LEVEL:=info}
: ${RABBITMQ_DISK_FREE_LIMIT:=50MB}
: ${RABBITMQ_VM_MEMORY_HIGH_WATERMARK:=0.8}


if [ "$KUBERNETES_HOSTNAME_FIX" == true ]; then
    echo "Applying kubernetes hostname fix ..."

    if [ -z "$(cat /etc/hosts | grep $HOSTNAME)" ]; then
        echo "127.0.0.1    $(hostname -f)    $(hostname)" >> /etc/hosts
        echo "::1    $(hostname -f)    $(hostname)" >> /etc/hosts
        echo "$(hostname -i | head -n 1)    $(hostname -f)    $(hostname)" >> /etc/hosts
    fi

    echo "$HOSTNAME" > /etc/hostname

    echo -e "
    HOSTNAME: $HOSTNAME
    which: $(which hostname)
    Container IP: $(hostname -i) 
    Container Host: $(hostname)
    Container FQDN: $(hostname -f)"
fi


echo "Writing rabbitmq.config ..."
tee /etc/rabbitmq/rabbitmq.config <<EOF
[
{rabbit, [{disk_free_limit, "${RABBITMQ_DISK_FREE_LIMIT}"}
          ,{vm_memory_high_watermark, ${RABBITMQ_VM_MEMORY_HIGH_WATERMARK}}
          ,{loopback_users, []}
          ,{log_levels, [{connection, $(echo $RABBITMQ_LOG_LEVEL | awk '{print tolower($0)}')}]}
         ]},
{rabbitmq_management, [{rates_mode, none}]},
{rabbitmq_management_agent, [{rates_mode, none}]}
].
EOF


echo "Linking Erlang Cookie ..."
if [ -f '/etc/secrets/erlang/cookie' ]; then
    ERLANG_COOKIE=$(cat /etc/secrets/erlang/cookie)
else
    echo "*** No Erlang Cookie Mounted! ***"
    ERLANG_COOKIE=insecure-cookie
fi
echo "$ERLANG_COOKIE" > ~/.erlang.cookie


echo "Ensuring permissions ..."
chown rabbitmq:rabbitmq ~/.erlang.cookie
chmod 0600 ~/.erlang.cookie


echo "Enabling plugins ..."
rabbitmq-plugins enable --offline rabbitmq_management


echo "Starting rabbitmq ..."
cd ~
    su rabbitmq -c 'exec rabbitmq-server 2>&1'
